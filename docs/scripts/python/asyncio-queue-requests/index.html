<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="asyncio-queue-requests"><meta property="og:title" content="asyncio-queue-requests"><meta property="og:description" content="Download #!/usr/bin/env python3 # poetry add httpx=='^0.23.0' pyquery=='^1.4.3' import logging from asyncio import Event from asyncio import Queue from asyncio import create_task from asyncio import gather from asyncio import run from asyncio.exceptions import CancelledError from functools import partial from typing import Any from typing import Callable from typing import Coroutine from urllib.parse import urlparse from urllib.parse import urlunparse from httpx import AsyncClient from pyquery import PyQuery logging.basicConfig() logger = logging."><meta property="og:type" content="article"><meta property="og:url" content="https://hellupline.dev/docs/scripts/python/asyncio-queue-requests/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2022-11-17T13:24:50-03:00"><title>asyncio-queue-requests | hellupline notes</title><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.cea3365593dd5d3c2d48221ab704f8cd942e6b2bbaec20b8d011c21c306e6dd0.css integrity="sha256-zqM2VZPdXTwtSCIatwT4zZQuayu67CC40BHCHDBubdA="><script defer src=/en.search.min.9f1d9ada344b555d5f33e868d686baae77d25e5b62a343b40bc1cdfd55dbf7dd.js integrity="sha256-nx2a2jRLVV1fM+ho1oa6rnfSXltio0O0C8HN/VXb990="></script></head><body><input type=checkbox class=hidden id=menu-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/><span>hellupline notes</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><span>articles</span><ul><li><a href=/docs/articles/gallery/>gallery</a></li><li><a href=/docs/articles/todo/>todo</a></li></ul></li><li><span>cheatsheets</span><ul><li><a href=/docs/cheatsheets/aws/>aws</a></li><li><a href=/docs/cheatsheets/curl/>curl</a></li><li><a href=/docs/cheatsheets/desktop-linux/>desktop-linux</a></li><li><a href=/docs/cheatsheets/desktop-osx/>desktop-osx</a></li><li><a href=/docs/cheatsheets/docker/>docker</a></li><li><a href=/docs/cheatsheets/ffmpeg/>ffmpeg</a></li><li><a href=/docs/cheatsheets/find/>find</a></li><li><a href=/docs/cheatsheets/github/>github</a></li><li><a href=/docs/cheatsheets/gpg/>gpg</a></li><li><a href=/docs/cheatsheets/kubernetes/>kubernetes</a></li><li><a href=/docs/cheatsheets/luks/>luks</a></li><li><a href=/docs/cheatsheets/mdadm/>mdadm</a></li><li><a href=/docs/cheatsheets/mysql/>mysql</a></li><li><a href=/docs/cheatsheets/network/>network</a></li><li><a href=/docs/cheatsheets/nginx/>nginx</a></li><li><a href=/docs/cheatsheets/openssl/>openssl</a></li><li><a href=/docs/cheatsheets/postgres/>postgres</a></li><li><a href=/docs/cheatsheets/python/>python</a></li><li><a href=/docs/cheatsheets/redshift/>redshift</a></li><li><a href=/docs/cheatsheets/rsync/>rsync</a></li><li><a href=/docs/cheatsheets/ssh/>ssh</a></li><li><a href=/docs/cheatsheets/sysadmin/>sysadmin</a></li><li><a href=/docs/cheatsheets/utils/>utils</a></li></ul></li><li><span>configurations</span><ul><li><span>kubernetes</span><ul><li><a href=/docs/configurations/kubernetes/configmap/>configmap</a></li><li><a href=/docs/configurations/kubernetes/cronjob/>cronjob</a></li><li><a href=/docs/configurations/kubernetes/daemonset/>daemonset</a></li><li><a href=/docs/configurations/kubernetes/deployment/>deployment</a></li><li><a href=/docs/configurations/kubernetes/hpa/>hpa</a></li><li><a href=/docs/configurations/kubernetes/ingress/>ingress</a></li><li><a href=/docs/configurations/kubernetes/job/>job</a></li><li><a href=/docs/configurations/kubernetes/namespace/>namespace</a></li><li><a href=/docs/configurations/kubernetes/pod/>pod</a></li><li><a href=/docs/configurations/kubernetes/private-registry-credentials/>private-registry-credentials</a></li><li><a href=/docs/configurations/kubernetes/rbac-aggregated-maintenance/>rbac-aggregated-maintenance</a></li><li><a href=/docs/configurations/kubernetes/rbac-cluster-full-access/>rbac-cluster-full-access</a></li><li><a href=/docs/configurations/kubernetes/rbac-cluster-read-only/>rbac-cluster-read-only</a></li><li><a href=/docs/configurations/kubernetes/rbac-namespace-full-access/>rbac-namespace-full-access</a></li><li><a href=/docs/configurations/kubernetes/rbac-namespace-read-only/>rbac-namespace-read-only</a></li><li><a href=/docs/configurations/kubernetes/secret/>secret</a></li><li><a href=/docs/configurations/kubernetes/service/>service</a></li><li><a href=/docs/configurations/kubernetes/service-dns/>service-dns</a></li><li><a href=/docs/configurations/kubernetes/service-endpoint/>service-endpoint</a></li><li><a href=/docs/configurations/kubernetes/statefulset/>statefulset</a></li><li><a href=/docs/configurations/kubernetes/volume-cloud/>volume-cloud</a></li><li><a href=/docs/configurations/kubernetes/volume-local-disk/>volume-local-disk</a></li></ul></li><li><span>nginx</span><ul><li><a href=/docs/configurations/nginx/cached-proxy/>cached-proxy</a></li><li><a href=/docs/configurations/nginx/cors/>cors</a></li><li><a href=/docs/configurations/nginx/hls-stream/>hls-stream</a></li><li><a href=/docs/configurations/nginx/https/>https</a></li><li><a href=/docs/configurations/nginx/load-balancer/>load-balancer</a></li><li><a href=/docs/configurations/nginx/password/>password</a></li><li><a href=/docs/configurations/nginx/redirect/>redirect</a></li><li><a href=/docs/configurations/nginx/static-files/>static-files</a></li><li><a href=/docs/configurations/nginx/tcp-proxy/>tcp-proxy</a></li></ul></li><li><span>python</span><ul><li><a href=/docs/configurations/python/pyproject/>pyproject</a></li></ul></li></ul></li><li><span>scripts</span><ul><li><span>golang</span><ul><li><a href=/docs/scripts/golang/echoserver.go/>echoserver.go</a></li></ul></li><li><span>kubernetes</span><ul><li><a href=/docs/scripts/kubernetes/kubectl-context-list/>kubectl-context-list</a></li><li><a href=/docs/scripts/kubernetes/kubectl-context-set/>kubectl-context-set</a></li><li><a href=/docs/scripts/kubernetes/kubectl-ingress-health/>kubectl-ingress-health</a></li><li><a href=/docs/scripts/kubernetes/kubectl-namespace-list/>kubectl-namespace-list</a></li><li><a href=/docs/scripts/kubernetes/kubectl-namespace-set/>kubectl-namespace-set</a></li><li><a href=/docs/scripts/kubernetes/kubectl-pods-failed/>kubectl-pods-failed</a></li><li><a href=/docs/scripts/kubernetes/kubectl-shell/>kubectl-shell</a></li></ul></li><li><span>python</span><ul><li><a href=/docs/scripts/python/asyncio-queue-requests/ class=active>asyncio-queue-requests</a></li><li><a href=/docs/scripts/python/ftpython/>ftpython</a></li><li><a href=/docs/scripts/python/opensearch-export-csv/>opensearch-export-csv</a></li><li><a href=/docs/scripts/python/simple-https/>simple-https</a></li></ul></li><li><span>toys</span><ul><li><a href=/docs/scripts/toys/bonsai/>bonsai</a></li><li><a href=/docs/scripts/toys/colorbars/>colorbars</a></li><li><a href=/docs/scripts/toys/dna/>dna</a></li><li><a href=/docs/scripts/toys/food/>food</a></li><li><a href=/docs/scripts/toys/ghosts/>ghosts</a></li><li><a href=/docs/scripts/toys/invaders/>invaders</a></li><li><a href=/docs/scripts/toys/metroid/>metroid</a></li><li><a href=/docs/scripts/toys/pacman-colors/>pacman-colors</a></li><li><a href=/docs/scripts/toys/pipes/>pipes</a></li><li><a href=/docs/scripts/toys/pipesx/>pipesx</a></li><li><a href=/docs/scripts/toys/rain/>rain</a></li><li><a href=/docs/scripts/toys/ryu/>ryu</a></li><li><a href=/docs/scripts/toys/skull/>skull</a></li><li><a href=/docs/scripts/toys/slendy/>slendy</a></li></ul></li><li><span>utils</span><ul><li><a href=/docs/scripts/utils/blurlock/>blurlock</a></li><li><a href=/docs/scripts/utils/cached/>cached</a></li><li><a href=/docs/scripts/utils/clipboard-watch/>clipboard-watch</a></li><li><a href=/docs/scripts/utils/git-cleanup/>git-cleanup</a></li><li><a href=/docs/scripts/utils/lets-encrypt-cloudflare/>lets-encrypt-cloudflare</a></li><li><a href=/docs/scripts/utils/lets-encrypt-cname/>lets-encrypt-cname</a></li><li><a href=/docs/scripts/utils/make-cacert/>make-cacert</a></li><li><a href=/docs/scripts/utils/make-cacert-certificate/>make-cacert-certificate</a></li><li><a href=/docs/scripts/utils/make-selfsign-certificate/>make-selfsign-certificate</a></li><li><a href=/docs/scripts/utils/play-old/>play-old</a></li><li><a href=/docs/scripts/utils/play-random/>play-random</a></li><li><a href=/docs/scripts/utils/screenshot/>screenshot</a></li><li><a href=/docs/scripts/utils/show-certs/>show-certs</a></li><li><a href=/docs/scripts/utils/spotifyctl/>spotifyctl</a></li><li><a href=/docs/scripts/utils/tabular/>tabular</a></li><li><a href=/docs/scripts/utils/template/>template</a></li><li><a href=/docs/scripts/utils/utcnow/>utcnow</a></li><li><a href=/docs/scripts/utils/wallpapers/>wallpapers</a></li><li><a href=/docs/scripts/utils/window-autoclick/>window-autoclick</a></li></ul></li></ul></li></ul><ul><li><a href=https://github.com/hellupline target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var e=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>asyncio-queue-requests</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><input type=checkbox class=hidden id=toc-control><aside class="hidden clearfix"><nav id=TableOfContents></nav></aside></header><article class=markdown><div style=text-align:right><a href=/files/docs/scripts/python/asyncio-queue-requests.py>Download</a></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># poetry add httpx==&#39;^0.23.0&#39; pyquery==&#39;^1.4.3&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>logging</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>asyncio</span> <span style=color:#f92672>import</span> <span style=color:#111>Event</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>asyncio</span> <span style=color:#f92672>import</span> <span style=color:#111>Queue</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>asyncio</span> <span style=color:#f92672>import</span> <span style=color:#111>create_task</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>asyncio</span> <span style=color:#f92672>import</span> <span style=color:#111>gather</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>asyncio</span> <span style=color:#f92672>import</span> <span style=color:#111>run</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>asyncio.exceptions</span> <span style=color:#f92672>import</span> <span style=color:#111>CancelledError</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>functools</span> <span style=color:#f92672>import</span> <span style=color:#111>partial</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>typing</span> <span style=color:#f92672>import</span> <span style=color:#111>Any</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>typing</span> <span style=color:#f92672>import</span> <span style=color:#111>Callable</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>typing</span> <span style=color:#f92672>import</span> <span style=color:#111>Coroutine</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>urllib.parse</span> <span style=color:#f92672>import</span> <span style=color:#111>urlparse</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>urllib.parse</span> <span style=color:#f92672>import</span> <span style=color:#111>urlunparse</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>httpx</span> <span style=color:#f92672>import</span> <span style=color:#111>AsyncClient</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>pyquery</span> <span style=color:#f92672>import</span> <span style=color:#111>PyQuery</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>logging</span><span style=color:#f92672>.</span><span style=color:#111>basicConfig</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>logger</span> <span style=color:#f92672>=</span> <span style=color:#111>logging</span><span style=color:#f92672>.</span><span style=color:#111>getLogger</span><span style=color:#111>(</span><span style=color:#111>__name__</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>visited</span><span style=color:#111>:</span> <span style=color:#111>set</span><span style=color:#111>[</span><span style=color:#111>str</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>set</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>async</span> <span style=color:#00a8c8>def</span> <span style=color:#75af00>main</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>    <span style=color:#111>queue_request_urls</span> <span style=color:#f92672>=</span> <span style=color:#111>Queue</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>queue_extract_urls</span> <span style=color:#f92672>=</span> <span style=color:#111>Queue</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>queue_print_title</span> <span style=color:#f92672>=</span> <span style=color:#111>Queue</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>event_completed</span> <span style=color:#f92672>=</span> <span style=color:#111>Event</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>await</span> <span style=color:#111>queue_request_urls</span><span style=color:#f92672>.</span><span style=color:#111>put</span><span style=color:#111>((</span><span style=color:#d88200>&#34;https://hellupline.dev/&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;https://hellupline.dev/&#34;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>async</span> <span style=color:#00a8c8>with</span> <span style=color:#111>AsyncClient</span><span style=color:#111>()</span> <span style=color:#00a8c8>as</span> <span style=color:#111>client</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>f_request_url</span> <span style=color:#f92672>=</span> <span style=color:#111>partial</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>            <span style=color:#111>_request_url</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>            <span style=color:#111>client</span><span style=color:#f92672>=</span><span style=color:#111>client</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>            <span style=color:#111>queue_output</span><span style=color:#f92672>=</span><span style=color:#111>queue_extract_urls</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>        <span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>f_request_url</span><span style=color:#f92672>.</span><span style=color:#111>__name__</span> <span style=color:#f92672>=</span> <span style=color:#111>_request_url</span><span style=color:#f92672>.</span><span style=color:#111>__name__</span>
</span></span><span style=display:flex><span>        <span style=color:#111>f_extract_data</span> <span style=color:#f92672>=</span> <span style=color:#111>partial</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>            <span style=color:#111>_extract_data</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>            <span style=color:#111>event_completed</span><span style=color:#f92672>=</span><span style=color:#111>event_completed</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>            <span style=color:#111>queue_output_1</span><span style=color:#f92672>=</span><span style=color:#111>queue_request_urls</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>            <span style=color:#111>queue_output_2</span><span style=color:#f92672>=</span><span style=color:#111>queue_print_title</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>        <span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>f_extract_data</span><span style=color:#f92672>.</span><span style=color:#111>__name__</span> <span style=color:#f92672>=</span> <span style=color:#111>_extract_data</span><span style=color:#f92672>.</span><span style=color:#111>__name__</span>
</span></span><span style=display:flex><span>        <span style=color:#111>tasks_request_urls</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span>
</span></span><span style=display:flex><span>            <span style=color:#111>create_task</span><span style=color:#111>(</span><span style=color:#111>queue_task</span><span style=color:#111>(</span><span style=color:#111>queue_input</span><span style=color:#f92672>=</span><span style=color:#111>queue_request_urls</span><span style=color:#111>,</span> <span style=color:#111>task_index</span><span style=color:#f92672>=</span><span style=color:#111>i</span><span style=color:#111>,</span> <span style=color:#111>function</span><span style=color:#f92672>=</span><span style=color:#111>f_request_url</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>for</span> <span style=color:#111>i</span> <span style=color:#f92672>in</span> <span style=color:#111>range</span><span style=color:#111>(</span><span style=color:#ae81ff>4</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>tasks_extract_urls</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span>
</span></span><span style=display:flex><span>            <span style=color:#111>create_task</span><span style=color:#111>(</span><span style=color:#111>queue_task</span><span style=color:#111>(</span><span style=color:#111>queue_input</span><span style=color:#f92672>=</span><span style=color:#111>queue_extract_urls</span><span style=color:#111>,</span> <span style=color:#111>task_index</span><span style=color:#f92672>=</span><span style=color:#111>i</span><span style=color:#111>,</span> <span style=color:#111>function</span><span style=color:#f92672>=</span><span style=color:#111>f_extract_data</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>for</span> <span style=color:#111>i</span> <span style=color:#f92672>in</span> <span style=color:#111>range</span><span style=color:#111>(</span><span style=color:#ae81ff>4</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>tasks_print_title</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span>
</span></span><span style=display:flex><span>            <span style=color:#111>create_task</span><span style=color:#111>(</span><span style=color:#111>queue_task</span><span style=color:#111>(</span><span style=color:#111>queue_input</span><span style=color:#f92672>=</span><span style=color:#111>queue_print_title</span><span style=color:#111>,</span> <span style=color:#111>task_index</span><span style=color:#f92672>=</span><span style=color:#111>i</span><span style=color:#111>,</span> <span style=color:#111>function</span><span style=color:#f92672>=</span><span style=color:#111>_print_title</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>for</span> <span style=color:#111>i</span> <span style=color:#f92672>in</span> <span style=color:#111>range</span><span style=color:#111>(</span><span style=color:#ae81ff>4</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>await</span> <span style=color:#111>event_completed</span><span style=color:#f92672>.</span><span style=color:#111>wait</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>await</span> <span style=color:#111>queue_request_urls</span><span style=color:#f92672>.</span><span style=color:#111>join</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>for</span> <span style=color:#111>task</span> <span style=color:#f92672>in</span> <span style=color:#111>tasks_request_urls</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#111>task</span><span style=color:#f92672>.</span><span style=color:#111>cancel</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>await</span> <span style=color:#111>gather</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#111>tasks_request_urls</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>logger</span><span style=color:#f92672>.</span><span style=color:#111>debug</span><span style=color:#111>(</span><span style=color:#d88200>&#34;request done&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>await</span> <span style=color:#111>queue_extract_urls</span><span style=color:#f92672>.</span><span style=color:#111>join</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>for</span> <span style=color:#111>task</span> <span style=color:#f92672>in</span> <span style=color:#111>tasks_extract_urls</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#111>task</span><span style=color:#f92672>.</span><span style=color:#111>cancel</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>await</span> <span style=color:#111>gather</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#111>tasks_extract_urls</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>logger</span><span style=color:#f92672>.</span><span style=color:#111>debug</span><span style=color:#111>(</span><span style=color:#d88200>&#34;extract done&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>await</span> <span style=color:#111>queue_print_title</span><span style=color:#f92672>.</span><span style=color:#111>join</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>for</span> <span style=color:#111>task</span> <span style=color:#f92672>in</span> <span style=color:#111>tasks_print_title</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#111>task</span><span style=color:#f92672>.</span><span style=color:#111>cancel</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>await</span> <span style=color:#111>gather</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#111>tasks_print_title</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>logger</span><span style=color:#f92672>.</span><span style=color:#111>debug</span><span style=color:#111>(</span><span style=color:#d88200>&#34;print done&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>async</span> <span style=color:#00a8c8>def</span> <span style=color:#75af00>queue_task</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>queue_input</span><span style=color:#111>:</span> <span style=color:#111>Queue</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>task_index</span><span style=color:#111>:</span> <span style=color:#111>int</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>function</span><span style=color:#111>:</span> <span style=color:#111>Callable</span><span style=color:#111>[</span><span style=color:#f92672>...</span><span style=color:#111>,</span> <span style=color:#111>Coroutine</span><span style=color:#111>[</span><span style=color:#111>Any</span><span style=color:#111>,</span> <span style=color:#111>Any</span><span style=color:#111>,</span> <span style=color:#111>Any</span><span style=color:#111>]],</span>
</span></span><span style=display:flex><span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>logger</span><span style=color:#f92672>.</span><span style=color:#111>debug</span><span style=color:#111>(</span><span style=color:#d88200>&#34;</span><span style=color:#d88200>%s</span><span style=color:#d88200>(</span><span style=color:#d88200>%d</span><span style=color:#d88200>) started&#34;</span><span style=color:#111>,</span> <span style=color:#111>function</span><span style=color:#f92672>.</span><span style=color:#111>__name__</span><span style=color:#111>,</span> <span style=color:#111>task_index</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>while</span> <span style=color:#00a8c8>True</span><span style=color:#111>:</span>  <span style=color:#75715e># not queue_input.empty()</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>try</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#111>data</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>await</span> <span style=color:#111>queue_input</span><span style=color:#f92672>.</span><span style=color:#111>get</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>except</span> <span style=color:#111>CancelledError</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#111>logger</span><span style=color:#f92672>.</span><span style=color:#111>debug</span><span style=color:#111>(</span><span style=color:#d88200>&#34;</span><span style=color:#d88200>%s</span><span style=color:#d88200>(</span><span style=color:#d88200>%d</span><span style=color:#d88200>) cancelled&#34;</span><span style=color:#111>,</span> <span style=color:#111>function</span><span style=color:#f92672>.</span><span style=color:#111>__name__</span><span style=color:#111>,</span> <span style=color:#111>task_index</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>        <span style=color:#111>logger</span><span style=color:#f92672>.</span><span style=color:#111>debug</span><span style=color:#111>(</span><span style=color:#d88200>&#34;</span><span style=color:#d88200>%s</span><span style=color:#d88200>(</span><span style=color:#d88200>%d</span><span style=color:#d88200>) extracting urls&#34;</span><span style=color:#111>,</span> <span style=color:#111>function</span><span style=color:#f92672>.</span><span style=color:#111>__name__</span><span style=color:#111>,</span> <span style=color:#111>task_index</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>try</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>await</span> <span style=color:#111>function</span><span style=color:#111>(</span><span style=color:#111>data</span><span style=color:#f92672>=</span><span style=color:#111>data</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>except</span> <span style=color:#75af00>Exception</span><span style=color:#111>:</span>  <span style=color:#75715e># pylint: disable=broad-except</span>
</span></span><span style=display:flex><span>            <span style=color:#111>logger</span><span style=color:#f92672>.</span><span style=color:#111>exception</span><span style=color:#111>(</span><span style=color:#d88200>&#34;</span><span style=color:#d88200>%s</span><span style=color:#d88200>(</span><span style=color:#d88200>%d</span><span style=color:#d88200>) failed to run task&#34;</span><span style=color:#111>,</span> <span style=color:#111>function</span><span style=color:#f92672>.</span><span style=color:#111>__name__</span><span style=color:#111>,</span> <span style=color:#111>task_index</span><span style=color:#111>)</span>  <span style=color:#75715e># raise</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>finally</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#111>queue_input</span><span style=color:#f92672>.</span><span style=color:#111>task_done</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>async</span> <span style=color:#00a8c8>def</span> <span style=color:#75af00>_request_url</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>data</span><span style=color:#111>:</span> <span style=color:#111>tuple</span><span style=color:#111>[</span><span style=color:#111>str</span><span style=color:#111>,</span> <span style=color:#111>str</span><span style=color:#111>],</span>
</span></span><span style=display:flex><span>    <span style=color:#111>client</span><span style=color:#111>:</span> <span style=color:#111>AsyncClient</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>queue_output</span><span style=color:#111>:</span> <span style=color:#111>Queue</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>url</span><span style=color:#111>,</span> <span style=color:#111>base_url</span> <span style=color:#f92672>=</span> <span style=color:#111>data</span>
</span></span><span style=display:flex><span>    <span style=color:#111>r</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>await</span> <span style=color:#111>client</span><span style=color:#f92672>.</span><span style=color:#111>request</span><span style=color:#111>(</span><span style=color:#111>method</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;GET&#34;</span><span style=color:#111>,</span> <span style=color:#111>url</span><span style=color:#f92672>=</span><span style=color:#111>url</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>await</span> <span style=color:#111>queue_output</span><span style=color:#f92672>.</span><span style=color:#111>put</span><span style=color:#111>((</span><span style=color:#111>r</span><span style=color:#f92672>.</span><span style=color:#111>text</span><span style=color:#111>,</span> <span style=color:#111>base_url</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>async</span> <span style=color:#00a8c8>def</span> <span style=color:#75af00>_extract_data</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>data</span><span style=color:#111>:</span> <span style=color:#111>tuple</span><span style=color:#111>[</span><span style=color:#111>str</span><span style=color:#111>,</span> <span style=color:#111>str</span><span style=color:#111>],</span>
</span></span><span style=display:flex><span>    <span style=color:#111>event_completed</span><span style=color:#111>:</span> <span style=color:#111>Event</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>queue_output_1</span><span style=color:#111>:</span> <span style=color:#111>Queue</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>queue_output_2</span><span style=color:#111>:</span> <span style=color:#111>Queue</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>text</span><span style=color:#111>,</span> <span style=color:#111>base_url</span> <span style=color:#f92672>=</span> <span style=color:#111>data</span>
</span></span><span style=display:flex><span>    <span style=color:#111>q</span> <span style=color:#f92672>=</span> <span style=color:#111>PyQuery</span><span style=color:#111>(</span><span style=color:#111>text</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>make_links_absolute</span><span style=color:#111>(</span><span style=color:#111>base_url</span><span style=color:#f92672>=</span><span style=color:#111>base_url</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>urls</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>_normalize_url</span><span style=color:#111>(</span><span style=color:#111>url</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>for</span> <span style=color:#111>url</span> <span style=color:#f92672>in</span> <span style=color:#111>(</span><span style=color:#111>tag</span><span style=color:#f92672>.</span><span style=color:#111>attrib</span><span style=color:#f92672>.</span><span style=color:#111>get</span><span style=color:#111>(</span><span style=color:#d88200>&#34;href&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;&#34;</span><span style=color:#111>)</span> <span style=color:#00a8c8>for</span> <span style=color:#111>tag</span> <span style=color:#f92672>in</span> <span style=color:#111>q</span><span style=color:#111>(</span><span style=color:#d88200>&#34;a&#34;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>_valid_url</span><span style=color:#111>(</span><span style=color:#111>url</span><span style=color:#111>,</span> <span style=color:#111>base_url</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#f92672>-</span> <span style=color:#111>visited</span>
</span></span><span style=display:flex><span>    <span style=color:#111>title</span> <span style=color:#f92672>=</span> <span style=color:#111>q</span><span style=color:#111>(</span><span style=color:#d88200>&#34;title&#34;</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>text</span><span style=color:#111>()</span><span style=color:#f92672>.</span><span style=color:#111>strip</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>visited</span><span style=color:#f92672>.</span><span style=color:#111>update</span><span style=color:#111>(</span><span style=color:#111>urls</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#111>url</span> <span style=color:#f92672>in</span> <span style=color:#111>urls</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>await</span> <span style=color:#111>queue_output_1</span><span style=color:#f92672>.</span><span style=color:#111>put</span><span style=color:#111>((</span><span style=color:#111>url</span><span style=color:#111>,</span> <span style=color:#111>base_url</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#f92672>not</span> <span style=color:#111>urls</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>event_completed</span><span style=color:#f92672>.</span><span style=color:#111>set</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>await</span> <span style=color:#111>queue_output_2</span><span style=color:#f92672>.</span><span style=color:#111>put</span><span style=color:#111>(</span><span style=color:#111>title</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>_normalize_url</span><span style=color:#111>(</span><span style=color:#111>url</span><span style=color:#111>:</span> <span style=color:#111>str</span><span style=color:#111>)</span> <span style=color:#f92672>-&gt;</span> <span style=color:#111>str</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>urlunparse</span><span style=color:#111>(</span><span style=color:#111>urlparse</span><span style=color:#111>(</span><span style=color:#111>url</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>_replace</span><span style=color:#111>(</span><span style=color:#111>fragment</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;&#34;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>_valid_url</span><span style=color:#111>(</span><span style=color:#111>url</span><span style=color:#111>:</span> <span style=color:#111>str</span><span style=color:#111>,</span> <span style=color:#111>base_url</span><span style=color:#111>:</span> <span style=color:#111>str</span><span style=color:#111>)</span> <span style=color:#f92672>-&gt;</span> <span style=color:#111>bool</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#111>base_u</span> <span style=color:#f92672>=</span> <span style=color:#111>urlparse</span><span style=color:#111>(</span><span style=color:#111>base_url</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>u</span> <span style=color:#f92672>=</span> <span style=color:#111>urlparse</span><span style=color:#111>(</span><span style=color:#111>url</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>(</span><span style=color:#111>base_u</span><span style=color:#f92672>.</span><span style=color:#111>hostname</span> <span style=color:#f92672>==</span> <span style=color:#111>u</span><span style=color:#f92672>.</span><span style=color:#111>hostname</span><span style=color:#111>)</span> <span style=color:#f92672>and</span> <span style=color:#111>(</span><span style=color:#111>u</span><span style=color:#f92672>.</span><span style=color:#111>path</span><span style=color:#f92672>.</span><span style=color:#111>endswith</span><span style=color:#111>(</span><span style=color:#d88200>&#34;/&#34;</span><span style=color:#111>))</span> <span style=color:#f92672>and</span> <span style=color:#111>(</span><span style=color:#111>u</span><span style=color:#f92672>.</span><span style=color:#111>fragment</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>async</span> <span style=color:#00a8c8>def</span> <span style=color:#75af00>_print_title</span><span style=color:#111>(</span><span style=color:#111>data</span><span style=color:#111>:</span> <span style=color:#111>str</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#d88200>&#34;title:&#34;</span><span style=color:#111>,</span> <span style=color:#111>data</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#111>__name__</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;__main__&#34;</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#111>run</span><span style=color:#111>(</span><span style=color:#111>main</span><span style=color:#111>())</span>
</span></span></code></pre></div></article><footer class=book-footer><div class="flex justify-between"><div><a class="flex align-center" href=https://github.com/hellupline/hellupline.github.io-source/commit/d65b6efaba2a0ae39e86bd46ae36b9f628165fa6 title='Last modified by Renan Traba | Nov 17, 2022' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>Nov 17, 2022</span></a></div><div><a class="flex align-center" href=https://github.com/hellupline/hellupline.github.io-source/edit/master/content/docs/scripts/python/asyncio-queue-requests.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents></nav></aside></main></body></html>